<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RiceAtlas: Checks and Reshuffling of data • phenoriceR</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">phenoriceR</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Data_extraction.html">Processing passages - Data Extraction</a>
    </li>
    <li>
      <a href="../articles/processing_summary.html">Processing passages</a>
    </li>
    <li>
      <a href="../articles/RiceAtlas_Comparison.html">RiceAtlas Comparison</a>
    </li>
    <li>
      <a href="../articles/RiceAtlas_Reshuffling.html">RiceAtlas: Checks and Reshuffling of data</a>
    </li>
    <li>
      <a href="../articles/RiceAtlas_Work.html">RiceAtlas - Questions and proposals for processing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/lbusett/phenoriceR">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>RiceAtlas: Checks and Reshuffling of data</h1>
            
          </div>

    
    
<div class="contents">
<p>Here I am going to document the passages used to reshuffle the RiceAtlas dataset, and correct inconsistencies, needed to allow an easier comparison with PhenoRice results.</p>
<div id="preprocessing---changes-on-data-organization" class="section level1">
<h1 class="hasAnchor">
<a href="#preprocessing---changes-on-data-organization" class="anchor"></a>Preprocessing - changes on data organization</h1>
<p>The original “RiceAtlas” attribute table is organized in “wide” format, with one row for “subregion”, and many columns containing the data for the different seasons (e.g., <strong>PLANT_ST_1</strong>, <strong>PLANT_ST_2</strong>, ….).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">main_folder &lt;-<span class="st"> "/home/lb/my_data/prasia/Data/"</span>

in_riceatlas_shp =<span class="st"> </span><span class="kw">read_vect</span>(<span class="kw">file.path</span>(main_folder,
                                       <span class="st">"vector/Ricetlas/riceatlas_asia.shp"</span>))
<span class="co"># print(head(in_riceatlas_shp, 2), width = 800)</span></code></pre></div>
<p>This makes working with the dataset difficult. First thing we (Bhogendra) did, was transforming the dataset in a more “manageable” long format:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">in_data &lt;-<span class="st"> </span>data.table<span class="op">::</span><span class="kw">fread</span>(<span class="kw">file.path</span>(main_folder,
                                       <span class="st">"/vector/NormalizedDB.txt"</span>))
<span class="kw">head</span>(in_data)</code></pre></div>
<pre><code>##    Objectid ISO Country Region Sub_region N_seasons   Method Season
## 1:        1 BRN  Brunei Belait         NA         1 planting   Main
## 2:        1 BRN  Brunei Belait         NA         1 planting     NA
## 3:        1 BRN  Brunei Belait         NA         1 planting     NA
## 4:        1 BRN  Brunei Belait         NA         1 planting   Main
## 5:        1 BRN  Brunei Belait         NA         1 planting     NA
## 6:        1 BRN  Brunei Belait         NA         1 planting     NA
##    Pheno_stage Start Peak End Total_area Seasonal_area Seasonal_production
## 1:   plant_st1   274  288 304       1862          1862                1119
## 2:   plant_st2     0    0   0       1862             0                   0
## 3:   plant_st3     0    0   0       1862             0                   0
## 4:    harv_st1     1   15  31       1862          1862                1119
## 5:    harv_st2     0    0   0       1862             0                   0
## 6:    harv_st3     0    0   0       1862             0                   0</code></pre>
<p>Now, we have multiple rows per subregion, each corresponding to a possible “Season” and to a Phenological “indicator” (e.g., Planting or Harvesting). We can do some additional reshuffling for ease of use:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">in_atlas &lt;-<span class="st"> </span>in_data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># split the "Pheno_stage" column</span>
<span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyr/topics/separate">separate</a></span>(Pheno_stage, <span class="kw">c</span>(<span class="st">"Stage"</span>, <span class="st">"season"</span>), <span class="st">"_st"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># remove empty rows</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>((Start <span class="op">!=</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>Peak <span class="op">!=</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span>End <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># create a unique name for each region and a unique identifier ysung ISO + OBJID</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">ID_name =</span> <span class="kw">paste</span>(ISO, Region, Sub_region, <span class="dt">sep =</span> <span class="st">"_"</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">ID_name =</span> stringr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/stringr/topics/str_replace">str_replace</a></span>(ID_name, <span class="st">"NA"</span>, <span class="st">""</span>))<span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">ID =</span> <span class="kw">paste</span>(ISO, Objectid, <span class="dt">sep =</span> <span class="st">"_"</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co">#remove whitespaces from "Region"</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Region =</span> <span class="kw">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, Region) ) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">ID_name =</span> <span class="kw">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, ID_name) ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># Rename and reorder columns</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(ID, ID_name, N_seasons, season,
                Stage, Start, Peak, End, Total_area, Seasonal_area,
                Seasonal_production, Season, Country, Region, Sub_region,
                Objectid, ISO) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">rename</a></span>(<span class="dt">cty =</span> ISO, <span class="dt">N_seas =</span> N_seasons, <span class="dt">Seas_name =</span> Season, <span class="dt">Season =</span> season,
                <span class="dt">Seas_area =</span> Seasonal_area , <span class="dt">Seas_prod =</span> Seasonal_production,
                <span class="dt">Tot_area =</span> Total_area, <span class="dt">OBJECTID =</span> Objectid) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Stage =</span> <span class="kw">factor</span>(Stage,
                               <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">"plant"</span>, <span class="st">"harv"</span>),
                               <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">"Planting"</span>,<span class="st">"Harvesting"</span>))) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>tibble<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/tibble/topics/as_tibble">as_tibble</a></span>()

<span class="kw">head</span>(in_atlas)</code></pre></div>
<pre><code>## # A tibble: 6 x 17
##      ID       ID_name N_seas Season      Stage Start  Peak   End Tot_area
##   &lt;chr&gt;         &lt;chr&gt;  &lt;int&gt;  &lt;chr&gt;     &lt;fctr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;
## 1 BRN_1   BRN_Belait_      1      1   Planting   274   288   304     1862
## 2 BRN_1   BRN_Belait_      1      1 Harvesting     1    15    31     1862
## 3 BTN_2 BTN_Bumthang_      1      1   Planting   166   181   196       15
## 4 BTN_2 BTN_Bumthang_      1      1 Harvesting   305   319   334       15
## 5 BTN_3  BTN_Chhukha_      1      1   Planting   166   181   196     1130
## 6 BTN_3  BTN_Chhukha_      1      1 Harvesting   305   319   334     1130
## # ... with 8 more variables: Seas_area &lt;int&gt;, Seas_prod &lt;int&gt;,
## #   Seas_name &lt;chr&gt;, Country &lt;chr&gt;, Region &lt;chr&gt;, Sub_region &lt;chr&gt;,
## #   OBJECTID &lt;int&gt;, cty &lt;chr&gt;</code></pre>
</div>
<div id="checks-on-consistency-of-the-dataset" class="section level1">
<h1 class="hasAnchor">
<a href="#checks-on-consistency-of-the-dataset" class="anchor"></a>Checks on “consistency of the dataset”</h1>
<p>A quick check on the “consistency” of the dataset can be made by computing and plotting the differences between the reported “Start”, “Peak” and “End” DOYs, for each region.</p>
<p><img src="RiceAtlas_Reshuffling_files/figure-html/unnamed-chunk-5-1.png" width="480"><img src="RiceAtlas_Reshuffling_files/figure-html/unnamed-chunk-5-2.png" width="480"><img src="RiceAtlas_Reshuffling_files/figure-html/unnamed-chunk-5-3.png" width="480"></p>
<p>From this, it is obvious that the dataset is usually coherent, but also that it has some problems. In several cases Start/Peak/End values do not account for “circularity”.</p>
<p>Therefore we can have cases such as:</p>
<ol style="list-style-type: decimal">
<li><p><code>Start = 354,Peak = 3, End = 18</code> –&gt; <code>End &lt;=Start</code> and <code>Peak &lt;= Start</code> –&gt; leading to negative outliers</p></li>
<li><p><code>Start = 4, Peak = 292, End = 34</code> –&gt; <code>End &lt;=Start</code> and <code>Peak &lt;= Start</code> –&gt; leading to positive outliers</p></li>
</ol>
<p>, plus other less common problems (e.g., <code>Start = 32 ,Peak = 32, End = 0</code>, <code>Start = 148, Peak = 148, End = 155</code> <code>Start = 213 ,Peak = 227, End = 213</code>, <code>Start = 277, Peak = 19, End = 307</code>), as well as obvious mistakes (e.g., <code>Start = 74, Peak = 74, End = 196</code>, <code>Start = 1, Peak = 4, End = 66</code>)</p>
<p>We also have a very “anomalous” high frequency at <code>Peak - Start = 30</code>, but we can not do anything about that.</p>
<p>All this makes an automatic comparison with PhenoRice results difficult.</p>
<div id="initial-situation---phl" class="section level2">
<h2 class="hasAnchor">
<a href="#initial-situation---phl" class="anchor"></a>Initial situation - PHL</h2>
<p>For example, see what we have as <code>Start - Peak - End</code> ranges for some provinces in PHL:</p>
<p>A mix of correct data, some missing data (e.g, Tarlac Harvesting Start), and inconsistent data (e.g., Nueva Ecjia Planting; Bataan Harvesting). Most of the problems are obviously related to “circularization” of DOYS in Season 2, which crosses the year, and for which Start/Peak/End are evidently not coherent. In addition, we have the already mentioned problems of “switched” seasons, in some cases (though in the end this is the lesser problem)</p>
<p><img src="RiceAtlas_Reshuffling_files/figure-html/unnamed-chunk-6-1.png" width="768"><img src="RiceAtlas_Reshuffling_files/figure-html/unnamed-chunk-6-2.png" width="768"></p>
</div>
</div>
<div id="reshufflling-of-riceatlas-data-to-solve-the-problem" class="section level1">
<h1 class="hasAnchor">
<a href="#reshufflling-of-riceatlas-data-to-solve-the-problem" class="anchor"></a>Reshufflling of RiceAtlas data to solve the problem</h1>
<p>To solve the problem, we need to filter out errors and reshuffle the DOYS in a consistent way.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">out_atlas &lt;-<span class="st"> </span>in_atlas <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># add 365 to End/Peak where differences are negative</span>
<span class="st">  </span><span class="kw"><a href="../reference/pr_mutate_when.html">pr_mutate_when</a></span>((endstart_lgt <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>endstart_lgt <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>), 
                 <span class="kw">list</span>(<span class="dt">End =</span> End <span class="op">+</span><span class="st"> </span><span class="dv">365</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># re-create the diffs for test purposes</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">endstart_lgt =</span> (End <span class="op">-</span><span class="st"> </span>Start),
                <span class="dt">peakstart_lgt =</span> (Peak <span class="op">-</span><span class="st"> </span>Start), 
                <span class="dt">endpeak_lgt   =</span> (End <span class="op">-</span><span class="st"> </span>Peak)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Second fix where we still have prblems</span>
<span class="st">  </span><span class="kw"><a href="../reference/pr_mutate_when.html">pr_mutate_when</a></span>((endpeak_lgt <span class="op">&gt;</span><span class="st"> </span><span class="dv">250</span> <span class="op">&amp;</span><span class="st"> </span>peakstart_lgt <span class="op">&lt;</span><span class="st"> </span><span class="op">-</span><span class="dv">250</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(Start)), 
                 <span class="kw">list</span>(<span class="dt">Start =</span> Start <span class="op">-</span><span class="st"> </span><span class="dv">365</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/pr_mutate_when.html">pr_mutate_when</a></span>((endpeak_lgt <span class="op">&gt;</span><span class="st"> </span><span class="dv">250</span> <span class="op">&amp;</span><span class="st"> </span>peakstart_lgt <span class="op">&lt;</span><span class="st"> </span><span class="op">-</span><span class="dv">250</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(End)), 
                 <span class="kw">list</span>(<span class="dt">End   =</span> End <span class="op">-</span><span class="st"> </span><span class="dv">365</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># re-create the diffs for test purposes</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">endstart_lgt =</span> (End <span class="op">-</span><span class="st"> </span>Start),
                <span class="dt">peakstart_lgt =</span> (Peak <span class="op">-</span><span class="st"> </span>Start), 
                <span class="dt">endpeak_lgt   =</span> (End <span class="op">-</span><span class="st"> </span>Peak)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># Third fix where we still have prblems</span>
<span class="st">  </span><span class="kw"><a href="../reference/pr_mutate_when.html">pr_mutate_when</a></span>(endpeak_lgt <span class="op">&gt;</span><span class="st"> </span><span class="dv">300</span>, 
                 <span class="kw">list</span>(<span class="dt">End   =</span> End <span class="op">-</span><span class="st"> </span><span class="dv">365</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># re-create the diffs for test purposes</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">endstart_lgt =</span> (End <span class="op">-</span><span class="st"> </span>Start),
                <span class="dt">peakstart_lgt =</span> (Peak <span class="op">-</span><span class="st"> </span>Start), 
                <span class="dt">endpeak_lgt   =</span> (End <span class="op">-</span><span class="st"> </span>Peak)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># Remove Start/End when they are equal to Peak</span>
<span class="st">  </span><span class="kw"><a href="../reference/pr_mutate_when.html">pr_mutate_when</a></span>((Start <span class="op">==</span><span class="st"> </span>Peak), <span class="kw">list</span>(<span class="dt">Start =</span> <span class="ot">NA</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/pr_mutate_when.html">pr_mutate_when</a></span>((End <span class="op">==</span><span class="st"> </span>Peak),   <span class="kw">list</span>(<span class="dt">End   =</span> <span class="ot">NA</span>)) 

<span class="co"># Now manually fixErros and corner cases</span>
out_atlas &lt;-<span class="st"> </span>out_atlas <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co">#manually fix corner cases</span>
<span class="st">  </span><span class="co">#"IND Puducherry Yanam", which has very strange data on the original table</span>
<span class="st">  </span><span class="co">#( Harvesting:  Start  = 4  Peak = 292  End = 34;  Planting: Start  = 277   Peak = 19   End = 307).</span>
<span class="st">  </span><span class="co">#The obnly reasonable way IMO is to remove Start and set End to 365 + 34 (Planting)</span>
<span class="st">  </span><span class="co">#and remove Start and End (Harvesting)</span>
<span class="st">  </span><span class="kw"><a href="../reference/pr_mutate_when.html">pr_mutate_when</a></span>((ID_name <span class="op">==</span><span class="st"> "IND Puducherry Yanam"</span> <span class="op">&amp;</span><span class="st"> </span>Stage <span class="op">==</span><span class="st"> "Harvesting"</span> <span class="op">&amp;</span><span class="st"> </span>Season <span class="op">==</span><span class="st"> </span><span class="dv">2</span>),
                 <span class="kw">list</span>(<span class="dt">Start =</span> <span class="ot">NA</span>, <span class="dt">End =</span> <span class="dv">365</span> <span class="op">+</span><span class="st"> </span>End)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/pr_mutate_when.html">pr_mutate_when</a></span>((ID_name <span class="op">==</span><span class="st"> "IND Puducherry Yanam"</span> <span class="op">&amp;</span><span class="st"> </span>Stage <span class="op">==</span><span class="st"> "Planting"</span> <span class="op">&amp;</span><span class="st"> </span>Season <span class="op">==</span><span class="st"> </span><span class="dv">2</span>),
                 <span class="kw">list</span>(<span class="dt">Start =</span> <span class="ot">NA</span>, <span class="dt">End =</span> <span class="ot">NA</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co">#"MMR Tanintharyi"</span>
<span class="st">  </span><span class="kw"><a href="../reference/pr_mutate_when.html">pr_mutate_when</a></span>((ID_name <span class="op">==</span><span class="st"> "MMR Tanintharyi "</span> <span class="op">&amp;</span><span class="st"> </span>Stage <span class="op">==</span><span class="st"> "Planting"</span> <span class="op">&amp;</span><span class="st"> </span>Season <span class="op">==</span><span class="st"> </span><span class="dv">2</span>),
                 <span class="kw">list</span>(<span class="dt">Start =</span> <span class="ot">NA</span>, <span class="dt">End   =</span> <span class="ot">NA</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co">#"severla places with "213   227   213"" --&gt; Remove End</span>
<span class="st">  </span><span class="kw"><a href="../reference/pr_mutate_when.html">pr_mutate_when</a></span>((Start <span class="op">==</span><span class="st"> </span><span class="dv">213</span> <span class="op">&amp;</span><span class="st"> </span>Peak <span class="op">==</span><span class="st"> </span><span class="dv">227</span> <span class="op">&amp;</span><span class="st"> </span>End <span class="op">==</span><span class="st"> </span><span class="dv">213</span>), <span class="kw">list</span>(<span class="dt">End =</span> <span class="ot">NA</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co">#IND Orissa Nuapada</span>
<span class="st">  </span><span class="kw"><a href="../reference/pr_mutate_when.html">pr_mutate_when</a></span>((ID_name <span class="op">==</span><span class="st"> "IND Orissa Nuapada"</span> <span class="op">&amp;</span><span class="st"> </span>Stage <span class="op">==</span><span class="st"> "Planting"</span> <span class="op">&amp;</span><span class="st"> </span>Season <span class="op">==</span><span class="st"> </span><span class="dv">3</span>),
                 <span class="kw">list</span>(<span class="dt">End =</span> <span class="ot">NA</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co">#IND Uttaranchal Naini Tal</span>
<span class="st">  </span><span class="kw"><a href="../reference/pr_mutate_when.html">pr_mutate_when</a></span>((ID_name <span class="op">==</span><span class="st"> "IND Uttaranchal Naini Tal"</span> <span class="op">&amp;</span><span class="st"> </span>Stage <span class="op">==</span><span class="st"> "Planting"</span> <span class="op">&amp;</span><span class="st"> </span>Season <span class="op">==</span><span class="st"> </span><span class="dv">1</span>),
                 <span class="kw">list</span>(<span class="dt">End =</span> <span class="ot">NA</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co">#IND Orissa Malkangiri: Peak == 0. Resete to midpoint S/E</span>
<span class="st">  </span><span class="kw"><a href="../reference/pr_mutate_when.html">pr_mutate_when</a></span>((ID_name <span class="op">==</span><span class="st"> "IND Orissa Malkangiri"</span> <span class="op">&amp;</span><span class="st"> </span>Stage <span class="op">==</span><span class="st"> "Planting"</span> <span class="op">&amp;</span><span class="st"> </span>Season <span class="op">==</span><span class="st"> </span><span class="dv">2</span>),
                 <span class="kw">list</span>(<span class="dt">Peak =</span> <span class="dv">258</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co">#several places with "319   305   334" --&gt; Remove Start</span>
<span class="st">  </span><span class="kw"><a href="../reference/pr_mutate_when.html">pr_mutate_when</a></span>((peakstart_lgt <span class="op">==</span><span class="st"> </span><span class="op">-</span><span class="dv">14</span>), <span class="kw">list</span>(<span class="dt">Start =</span> <span class="ot">NA</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co">#several places with "30   -5   35" --&gt; Remove Start</span>
<span class="st">  </span><span class="kw"><a href="../reference/pr_mutate_when.html">pr_mutate_when</a></span>((peakstart_lgt <span class="op">==</span><span class="st"> </span><span class="op">-</span><span class="dv">5</span>),                         <span class="kw">list</span>(<span class="dt">Start   =</span> <span class="ot">NA</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="co"># re-create the diffs for test purposes</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">endstart_lgt =</span> (End <span class="op">-</span><span class="st"> </span>Start),
                <span class="dt">peakstart_lgt =</span> (Peak <span class="op">-</span><span class="st"> </span>Start), 
                <span class="dt">endpeak_lgt   =</span> (End <span class="op">-</span><span class="st"> </span>Peak)) </code></pre></div>
<p>Let’s see again the histograms:</p>
<p><img src="RiceAtlas_Reshuffling_files/figure-html/unnamed-chunk-8-1.png" width="576"><img src="RiceAtlas_Reshuffling_files/figure-html/unnamed-chunk-8-2.png" width="576"><img src="RiceAtlas_Reshuffling_files/figure-html/unnamed-chunk-8-3.png" width="576"></p>
<p>Ok. Now we are in much better shape (note that I never touched the “Peak” date, which we take as “reference”). <code>End - Start</code> is always positive, as well as <code>End - Peak</code>. Still some polygons with “anomalously” large ranges, but we can live with those.</p>
<p>Let’s see the PHL region again:</p>
<p><img src="RiceAtlas_Reshuffling_files/figure-html/unnamed-chunk-9-1.png" width="768"></p>
<p><strong>Much better</strong> but still not there. Now I’ll have to reconcile the planting and the harvesting. If Harvesting after reshuffling is still before planting, subtract 365:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">reorganize &lt;-<span class="st"> </span><span class="cf">function</span>(sub_atlas) {
  <span class="cf">for</span> (seas <span class="cf">in</span> <span class="kw">unique</span>(sub_atlas<span class="op">$</span>Season)) {
    data_in &lt;-<span class="st"> </span>sub_atlas <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(Season <span class="op">==</span><span class="st"> </span>seas)
    <span class="cf">if</span> (data_in<span class="op">$</span>Peak[<span class="dv">1</span>] <span class="op">&gt;</span><span class="st"> </span>data_in<span class="op">$</span>Peak[<span class="dv">2</span>]) {
      sub_atlas[sub_atlas<span class="op">$</span>Season <span class="op">==</span><span class="st"> </span>seas,]<span class="op">$</span>Start[<span class="dv">1</span>] &lt;-<span class="st"> </span>data_in<span class="op">$</span>Start[<span class="dv">1</span>] <span class="op">-</span><span class="st"> </span><span class="dv">365</span>
      sub_atlas[sub_atlas<span class="op">$</span>Season <span class="op">==</span><span class="st"> </span>seas,]<span class="op">$</span>Peak[<span class="dv">1</span>]  &lt;-<span class="st"> </span>data_in<span class="op">$</span>Peak[<span class="dv">1</span>] <span class="op">-</span><span class="st"> </span><span class="dv">365</span>
      sub_atlas[sub_atlas<span class="op">$</span>Season <span class="op">==</span><span class="st"> </span>seas,]<span class="op">$</span>End[<span class="dv">1</span>]   &lt;-<span class="st"> </span>data_in<span class="op">$</span>End[<span class="dv">1</span>] <span class="op">-</span><span class="st"> </span><span class="dv">365</span>
    }
  }
  sub_atlas
}

final_out &lt;-<span class="st"> </span><span class="kw">list</span>()
regions &lt;-<span class="st"> </span><span class="kw">unique</span>(out_atlas<span class="op">$</span>ID_name)
<span class="cf">for</span> (regind <span class="cf">in</span> <span class="kw">seq_along</span>(regions)) {
  indata &lt;-<span class="st"> </span>out_atlas <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(ID_name <span class="op">==</span><span class="st"> </span>regions[regind])
  regions[regind]
  final_out[[regind]] &lt;-<span class="st"> </span><span class="kw">reorganize</span>(indata)
}
final_out &lt;-<span class="st"> </span>data.table<span class="op">::</span><span class="kw">rbindlist</span>(final_out)</code></pre></div>
<p>Let’s see the result:</p>
<p><img src="RiceAtlas_Reshuffling_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<p><strong>Almost ALL SET !</strong> Now reorder the seasons so that 1 - 2 - 3 is always in order (not really needed, but while we are at it….)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">final_out2 &lt;-<span class="st"> </span>final_out <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(ID_name, Stage) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Seas_ord =</span> <span class="kw">rank</span>(Peak, <span class="dt">ties.method =</span> <span class="st">"first"</span>))</code></pre></div>
<div id="final-situation---phl" class="section level2">
<h2 class="hasAnchor">
<a href="#final-situation---phl" class="anchor"></a>Final situation - PHL</h2>
<p>Here the final result:</p>
<p><img src="RiceAtlas_Reshuffling_files/figure-html/unnamed-chunk-13-1.png" width="672"><img src="RiceAtlas_Reshuffling_files/figure-html/unnamed-chunk-13-2.png" width="672"></p>
<p><strong>DONE! </strong> Now we have a coherent dataset. We can save the reshuflled dataset, after re-joining the geometry.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">in_shp &lt;-<span class="st"> </span>in_riceatlas_shp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(OBJECTID, ISO) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">cty =</span> ISO) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(cty, OBJECTID)

out_shp &lt;-<span class="st"> </span>in_shp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(final_out2)

<span class="kw">write_shape</span>(out_shp, <span class="kw">file.path</span>(main_folder, 
                               <span class="st">"/vector/Ricetlas/riceatlas_asia_reshuffled.shp"</span>), 
                               <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)
<span class="co"># out_phl &lt;- out_shp %&gt;% </span>
<span class="co">#   dplyr::filter(cty == "PHL", Seas_ord == 2, Stage == "Planting")</span>
<span class="co"># </span>
<span class="co"># plot_vect(out_phl, fill_var = "Peak", palette_name = "RdYlGn")</span></code></pre></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#preprocessing---changes-on-data-organization">Preprocessing - changes on data organization</a></li>
      <li>
<a href="#checks-on-consistency-of-the-dataset">Checks on “consistency of the dataset”</a><ul class="nav nav-pills nav-stacked">
<li><a href="#initial-situation---phl">Initial situation - PHL</a></li>
      </ul>
</li>
      <li>
<a href="#reshufflling-of-riceatlas-data-to-solve-the-problem">Reshufflling of RiceAtlas data to solve the problem</a><ul class="nav nav-pills nav-stacked">
<li><a href="#final-situation---phl">Final situation - PHL</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Lorenzo Busetto.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
